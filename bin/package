#!/usr/bin/env ruby

require "rubygems"
require "yaml"
require "tmpdir"

if File.exists? "Packfile"
    config = YAML::load(File.open("Packfile"))
end

@options = {
  :app_stylesheet => config["output"]["stylesheet"]     || "application.css",
  :app_javascript => config["output"]["javascript"]     || "application.js",
  :package        => config["output"]["package"]        || "assets.zip",
  :zip            => config["zip"]                      || true,
  :stylesheets    => config["stylesheets"].join(" ")    || "**/*.css",
  :javascripts    => config["javascripts"].join(" ")    || "**/*.js",
  :coffeescripts  => config["coffeescripts"].join(" ")  || "**/*.coffee",
  :sass           => config["sass"].join(" ")           || "**/*.scss **/*.sass",
  :extras         => config["extras"].join(" ")         || ""
}

@build_dir = Dir.tmpdir
@current_dir = Dir.pwd

system "cp -r . #{@build_dir}"
Dir.chdir(@build_dir)

system "coffee -c #{@options[:coffeescripts]}"
system "sass --update #{@options[:sass]}"
system "juicer merge --force -o #{@options[:app_stylesheet]} #{@options[:stylesheets]}"
system "juicer merge --force -i -o #{@options[:app_javascript]} #{@options[:javascripts]}"
system "zip #{@options[:package]} #{@options[:app_stylesheet]} #{@options[:app_javascript]} #{@options[:extras]}" if @options[:zip]

system "cp #{@options[:package]} #{@current_dir}"
